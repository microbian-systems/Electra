@using BlazorSortable
@inject SectionService SectionSvc
@inject IBlockRegistry BlockRegistry

<CascadingValue Value="_editContext">
<div class="canvas" @onclick="() => _editContext.ClearAll()">

    <Sortable TItem="ContentBlock" Items="_sections" OnUpdate="SortSections" Context="block" Group="sections">
        @{
            var sectionBlock = (SectionBlock)block;
            var gridClass = sectionBlock.Layout switch
            {
                SectionLayout.Full        => "cols-1",
                SectionLayout.TwoColumn   => "cols-2",
                SectionLayout.ThreeColumn => "cols-3",
                SectionLayout.Sidebar     => "cols-sidebar",
                _ => "cols-1"
            };
        }

        <div class="section-block @(_editContext.IsSectionActive(sectionBlock.Id) ? "is-active" : "")"
             @onclick:stopPropagation="true">

            <div class="section-toolbar">
                <button @onclick="@(() => DeleteSection(sectionBlock.Id))" title="Delete section">Delete Section</button>
            </div>

            <div class="section-grid @gridClass">
                @{
                    var columns = sectionBlock.Children
                        .OfType<ColumnBlock>()
                        .OrderBy(c => c.ColIndex)
                        .ToList();
                }
                @foreach (var column in columns)
                {
                    <div class="column-drop-target">
                        <Sortable TItem="ContentBlock" Items="column.Children" OnUpdate="@(args => SortBlocks(column, args))" Context="childBlock" Group="blocks">
                             <BlockWrapper Block="childBlock"
                                           SectionId="sectionBlock.Id"
                                           OnChanged="SavePage"
                                           OnDelete="@((Guid id) => DeleteBlock(sectionBlock.Id, id))" />
                        </Sortable>

                         <AddBlockButton OnAdd="@((string alias) => AddBlock(sectionBlock.Id, column.ColIndex, alias))" />
                    </div>
                }
            </div>
        </div>
    </Sortable>

    <AddSectionButton OnAdd="AddSection" />
</div>
</CascadingValue>

@code {
    [Parameter] public ContentDocument Page { get; set; } = default!;
    [Parameter] public EventCallback OnChanged { get; set; }

    private List<ContentBlock> _sections = [];
    private readonly BlockEditContext _editContext = new();

    protected override void OnParametersSet()
    {
        _sections = Page.Blocks.ToList();
    }

    private async Task AddSection(SectionLayout layout)
    {
        SectionSvc.AddSection(Page, layout);
        _sections = Page.Blocks.ToList();
        await SavePage();
    }

    private async Task DeleteSection(Guid sectionId)
    {
        _editContext.ClearAll();
        SectionSvc.RemoveSection(Page, sectionId);
        _sections = Page.Blocks.ToList();
        await SavePage();
    }

    private void SortSections(SortableEventArgs<ContentBlock> args)
    {
        if (args.OldIndex == args.NewIndex) return;
        
        var item = Page.Blocks[args.OldIndex];
        Page.Blocks.RemoveAt(args.OldIndex);
        Page.Blocks.Insert(args.NewIndex, item);
        
        // Update SortOrder
        for (int i = 0; i < Page.Blocks.Count; i++)
        {
            Page.Blocks[i].SortOrder = i;
        }
        
        _sections = Page.Blocks.ToList();
        SavePage();
    }

    private void SortBlocks(ColumnBlock column, SortableEventArgs<ContentBlock> args)
    {
        // Simple reordering within the same column
        if (args.OldIndex == args.NewIndex) return;
        
        var item = column.Children[args.OldIndex];
        column.Children.RemoveAt(args.OldIndex);
        column.Children.Insert(args.NewIndex, item);
        
        // Update SortOrder
        for (int i = 0; i < column.Children.Count; i++)
        {
            column.Children[i].SortOrder = i;
        }
        
        SavePage();
    }

    private async Task AddBlock(Guid sectionId, int colIndex, string blockAlias)
    {
        var block = CreateBlock(blockAlias);
        SectionSvc.AddBlock(Page, sectionId, colIndex, block);
        _editContext.SetActiveBlock(block.Id, sectionId);
        await SavePage();
    }

    private async Task DeleteBlock(Guid sectionId, Guid blockId)
    {
        SectionSvc.RemoveBlock(Page, sectionId, blockId);
        await SavePage();
    }

    private Task SavePage() => OnChanged.InvokeAsync();

    private static ContentBlock CreateBlock(string alias) => alias switch
    {
        "richTextBlock" => new RichTextBlock(),
        "heroBlock" => new HeroBlock(),
        "quoteBlock" => new QuoteBlock(),
        "markdownBlock" => new MarkdownBlock(),
        "htmlBlock" => new HtmlBlock(),
        "imageBlock" => new ImageBlock(),
        _ => throw new InvalidOperationException($"Unknown block type: {alias}")
    };
}
