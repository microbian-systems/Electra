@page "/admin/page/{PageId:guid}"
@rendermode RenderMode.InteractiveServer
@inject IPageService PageService
@inject NavigationManager Nav
@implements IAsyncDisposable

<AdminNavBar PageName="@(_page?.Name ?? "Loading...")" />

@if (_page is null)
{
    <p>Loading...</p>
}
else
{
    <div class="page-editor-header">
        <div>
            <h1>@_page.Name</h1>
            <div class="page-meta">
                @_page.Slug
                @if (_saving) { <span>Saving...</span> }
                else if (_saved) { <span class="saved">Saved</span> }
            </div>
        </div>
        <div class="page-actions">
            <a href="@_page.Slug" target="_blank" class="btn btn-ghost">View Page</a>
            <button class="btn btn-primary" @onclick="SaveNow">Save</button>
             <button class="btn btn-ghost" @onclick="@(() => Nav.NavigateTo("/admin"))">Back</button>
        </div>
    </div>

    <div class="card page-metadata">
        <div class="form-row">
            <div class="form-field">
                <label>Page Title</label>
                <input value="@_page.Properties.GetValueOrDefault("title")?.ToString()"
                       @oninput='e => { _page.Properties["title"] = e.Value ?? ""; ScheduleSave(); }' />
            </div>
            <div class="form-field">
                <label>Meta Description</label>
                <input value="@_page.Properties.GetValueOrDefault("description")?.ToString()"
                       @oninput='e => { _page.Properties["description"] = e.Value ?? ""; ScheduleSave(); }' />
            </div>
        </div>
    </div>

    <BlockCanvas Page="_page" OnChanged="ScheduleSave" />
}

@code {
    [Parameter] public Guid PageId { get; set; }

    private ContentDocument? _page;
    private bool _saving;
    private bool _saved;
    private CancellationTokenSource? _debounce;

    protected override async Task OnInitializedAsync()
    {
        _page = await PageService.GetByIdAsync(PageId);
        if (_page is null) Nav.NavigateTo("/admin");
    }

    private void ScheduleSave()
    {
        _saved = false;
        _debounce?.Cancel();
        _debounce = new CancellationTokenSource();
        var token = _debounce.Token;
        
        // Execute on thread pool to avoid blocking UI
        Task.Run(async () => {
            try 
            {
                await Task.Delay(800, token);
                if (!token.IsCancellationRequested)
                {
                    await InvokeAsync(SaveNow);
                }
            }
            catch (TaskCanceledException) { }
        });
    }

    private async Task SaveNow()
    {
        if (_page is null) return;
        _saving = true;
        _saved = false;
        StateHasChanged();
        await PageService.SavePageAsync(_page, "admin");
        _saving = false;
        _saved = true;
        StateHasChanged();
        await Task.Delay(2000);
        _saved = false;
        StateHasChanged();
    }

    public ValueTask DisposeAsync()
    {
        _debounce?.Cancel();
        _debounce?.Dispose();
        return ValueTask.CompletedTask;
    }
}
