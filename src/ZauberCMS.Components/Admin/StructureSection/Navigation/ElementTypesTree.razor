@using ZauberCMS.Core.Content.Parameters
@using ZauberCMS.Core.Shared

@implements ZauberCMS.Core.Sections.Interfaces.ISectionNav

@if (ContentTypeItems.Any())
{
    <ContentTypeTree 
        Data="@ContentTypeItems"
        Alias="@Constants.Sections.Trees.StructureElementTypeTree"
        OnExpand="OnExpandHandler"
        Change="OnChange"
        DisableContextMenu="@DisableContextMenu"
        @bind-Value="@Selection"/>

}

@code {

    public int SortOrder => 0;
    public string SectionNavGroupAlias => Constants.Sections.SectionNavGroups.StructureElementTypesNavGroup;

    [CascadingParameter] public IModalService ModalService { get; set; } = null!;

    [Inject] public AppState AppState { get; set; } = null!;
    [Inject] public TreeState TreeState { get; set; } = null!;
    
    [Parameter] public EventCallback<object> ValueChanged { get; set; }
    [Parameter] public bool DisableContextMenu { get; set; }

    private List<ContentType> ContentTypeItems { get; set; } = [];
    private object? Selection { get; set; }

    protected override async Task OnInitializedAsync()
    {
        AppState.OnContentTypeChanged += HandleContentTypeTreeChanged;
        TreeState.OnTreeValueChanged += TreeStateOnOnTreeValueChanged;
        await DataRefresh();
    }

    public void Dispose()
    {
        AppState.OnContentTypeChanged -= HandleContentTypeTreeChanged;
        TreeState.OnTreeValueChanged -= TreeStateOnOnTreeValueChanged;
    }

    private async Task HandleContentTypeTreeChanged(ContentType? content, string user)
    {
        await DataRefresh();
        StateHasChanged();
    }

    /// <summary>
    /// Remove the selected state
    /// </summary>
    /// <param name="obj"></param>
    private void TreeStateOnOnTreeValueChanged(object? obj)
    {
        if (obj != Selection)
        {
            Selection = null;
            StateHasChanged();
        }
    }

    private Task OnExpandHandler(TreeExpandEventArgs args)
    {
        if (args.Value is ContentType content)
        {
            var items = ContentService.QueryContentTypesAsync(new QueryContentTypesParameters
            {
                WhereClause = x => x.ParentId == content.Id,
                AmountPerPage = 100,
                OnlyElementTypes = true,
                IncludeFolders = true,
                OrderBy = GetContentTypesOrderBy.Name
            }).GetAwaiter().GetResult();
            args.Children.Data = items.Items;
            args.Children.TextProperty = "Name";
            args.Children.Template = TreeExtensions.CreateContentTypeTreeTemplate<RadzenTreeItem>();
            args.Children.HasChildren = HasChildren;

            TreeState.NodeExpanded(content.Id);
        }

        return Task.CompletedTask;
    }

    private bool HasChildren(object data)
    {
        if (data is ContentType content)
        {
            // Check if result is cached
            if (TreeState.HasChildrenCache.TryGetValue(content.Id, out var hasChildren))
            {
                return hasChildren;
            }

            // Calculate result and cache it
            hasChildren = Task.Run(() => ContentService.HasChildContentTypeAsync(new HasChildContentTypeParameters { ParentId = content.Id })).GetAwaiter().GetResult();
            TreeState.SetChildren(content.Id, hasChildren);

            return hasChildren;
        }

        return false;
    }

    private async Task DataRefresh()
    {
        var items = await ContentService.QueryContentTypesAsync(new QueryContentTypesParameters
        {
            AmountPerPage = 1000,
            OnlyElementTypes = true,
            IncludeFolders = true,
            WhereClause = x => x.ParentId == null,
            OrderBy = GetContentTypesOrderBy.Name
        });
        ContentTypeItems = items.Items.ToList();
    }

    private async Task OnChange()
    {
        TreeState.TreeValue = Selection;
        if (Selection is ContentType content)
        {
            if (ValueChanged.HasDelegate)
            {
                await ValueChanged.InvokeAsync(Selection);
            }
            else
            {
                NavigationManager.NavigateTo($"{Urls.AdminStructureUpdateContentType}/{content.Id}");
                StateHasChanged();
            }
        }
    }
}