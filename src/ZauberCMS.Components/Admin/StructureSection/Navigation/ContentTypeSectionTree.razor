@using ZauberCMS.Core.Content.Parameters
@using ZauberCMS.Core.Shared

@implements ZauberCMS.Core.Sections.Interfaces.ISectionNav

@if (ContentTypeItems.Any())
{
    <ContentTypeTree 
        Alias="@Constants.Sections.Trees.StructureContentTypeTree"
        Data="@ContentTypeItems"
        Change="OnChange"
        DisableContextMenu="@DisableContextMenu"
        @bind-Value="@Selection" />
}

@code {

    public int SortOrder => 0;
    public string SectionNavGroupAlias => Constants.Sections.SectionNavGroups.StructureContentTypesNavGroup;
    
    [CascadingParameter] public IModalService ModalService { get; set; } = null!;
    
    [Inject] public AppState AppState { get; set; } = null!;
    [Inject] public TreeState TreeState { get; set; } = null!;
    
    private List<ContentType> ContentTypeItems { get; set; } = [];
    private object? Selection { get; set; }

    [Parameter] public EventCallback<object> ValueChanged { get; set; }
    [Parameter] public bool DisableContextMenu { get; set; }
    
    protected override async Task OnInitializedAsync()
    {
        AppState.OnContentTypeChanged += HandleContentTypeTreeChanged;
        TreeState.OnTreeValueChanged += TreeStateOnOnTreeValueChanged;
        await DataRefresh();
    }

    public void Dispose()
    {
        AppState.OnContentTypeChanged -= HandleContentTypeTreeChanged;
        TreeState.OnTreeValueChanged -= TreeStateOnOnTreeValueChanged;
    }

    private async Task HandleContentTypeTreeChanged(ContentType? content, string user)
    {
        await DataRefresh();
        StateHasChanged();
    }

    /// <summary>
    /// Remove the selected state
    /// </summary>
    /// <param name="obj"></param>
    private void TreeStateOnOnTreeValueChanged(object? obj)
    {
        if (obj != Selection)
        {
            Selection = null;
            StateHasChanged();
        }
    }
    
    private async Task DataRefresh()
    {
        var items = await ContentService.QueryContentTypesAsync(new QueryContentTypesParameters
        {
            AmountPerPage = 1000,
            IncludeFolders = true,
            WhereClause = x => x.ParentId == null,
            OrderBy = GetContentTypesOrderBy.Name
        });
        ContentTypeItems = items.Items.ToList();
    }

    private async Task OnChange()
    {
        TreeState.TreeValue = Selection;
        if (Selection is ContentType content)
        {
            if (ValueChanged.HasDelegate)
            {
                await ValueChanged.InvokeAsync(Selection);
            }
            else
            {
                NavigationManager.NavigateTo($"{Urls.AdminStructureUpdateContentType}/{content.Id}");
                StateHasChanged();
            }
        }
    }

}