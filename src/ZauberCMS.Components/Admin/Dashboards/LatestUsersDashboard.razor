@using Electra.Models.Entities
@using ZauberCMS.Core.Membership.Models
@using ZauberCMS.Core.Membership.Parameters
@implements ZauberCMS.Core.Sections.Interfaces.ISectionDashboard

<RadzenDataGrid AllowFiltering="true"
                FilterPopupRenderMode="PopupRenderMode.Initial"
                FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                AllowPaging="true"
                PageSize="@AmountPerPage"
                AllowSorting="true"
                LoadData="@LoadData"
                IsLoading="@IsLoading"
                Count="@Count"
                Data="@Users"
                SelectionMode="DataGridSelectionMode.Single"
                RowSelect="@((ElectraUser value) => OnRowSelect(value))"
                PagerHorizontalAlign="HorizontalAlign.Center">
    <Columns>
        <RadzenDataGridColumn Property="UserName" Title="Username"/>
        <RadzenDataGridColumn Property="Email" Title="Email"/>
        <RadzenDataGridColumn Property="DateUpdated" Title="Last Updated">
            <Template Context="data">
                @data.ModifiedOn.Humanize()
            </Template>
        </RadzenDataGridColumn>
    </Columns>
</RadzenDataGrid>

@code {
    [Parameter] public int AmountPerPage { get; set; } = 20;
    [Parameter] public bool RefreshPage { get; set; }
    
    public string TabName => "Latest Users";
    public int SortOrder => 0;
    public string SectionAlias => Constants.Sections.UsersSection;

    private IEnumerable<ElectraUser> Users { get; set; } = [];
    private int Count { get; set; } 
    private bool IsLoading { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await LoadData(new LoadDataArgs {Top = AmountPerPage});
    }
    
    async Task LoadData(LoadDataArgs args)
    {
        IsLoading = true;

        await Task.Yield();

        var queryParams = new QueryUsersParameters
        {
            AmountPerPage = args.Top ?? AmountPerPage,
            PageIndex = (args.Skip ?? 0) / (args.Top ?? AmountPerPage),
            OrderBy = GetUsersOrderBy.DateCreatedDescending
        };

        if (!string.IsNullOrEmpty(args.Filter))
        {
            queryParams.SearchTerm = args.Filter;
        }

        var result = await MembershipService.QueryUsersAsync(queryParams);
        Count = (int)result.TotalItems;
        Users = result.Items;

        IsLoading = false;
    }

    private void OnRowSelect(object value)
    {
        if (value is ElectraUser selectedRow)
        {
            NavigationManager.NavigateTo($"{Urls.AdminUsersEdit}/{selectedRow.Id}", RefreshPage);
        }
    }

}