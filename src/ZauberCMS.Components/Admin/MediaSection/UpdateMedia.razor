@using ZauberCMS.Components.Admin.MediaSection.Dialogs
@using ZauberCMS.Core.Shared
@using ZauberCMS.Core.Media.Models
@attribute [Route(Urls.AdminCreateMediaFolder)]
@attribute [Route($"{Urls.AdminCreateMediaFolder}/{{ParentId:guid}}")]
@attribute [Route($"{Urls.AdminUpdateMedia}/{{MediaId:guid}}")]
@layout SectionLayout
@implements IDisposable

<PageTitle>Update Media</PageTitle>

<RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Right" Gap="5" Style="margin-top: 0; padding-top: 0; padding-bottom: 10px;">
    <CreateMediaButtons @key="@GetCompositeKey(MediaId, ParentId)" ParentId="ParentId"/>
</RadzenStack>

<RadzenPanel Class="rz-mx-auto">

    <UpdateMediaForm @key="GetCompositeKey(MediaId, ParentId)" MediaId="@MediaId" ParentId="@ParentId" />    

</RadzenPanel>

@code {
    [Parameter] public string? ParentId { get; set; }
    [Parameter] public string? MediaId { get; set; }
    
    [Inject] public AppState AppState { get; set; } = null!;
    
    [CascadingParameter] protected SectionLayout? Layout { get; set; }

    protected override void OnInitialized()
    {
        Layout?.SetSection(Constants.Sections.MediaSection);
        AppState.OnMediaDeleted += HandleMediaDeleted;
    }

    private async Task HandleMediaDeleted(Media? media, string username)
    {
        // If viewing a specific media item and it gets deleted, navigate to media index
        if (MediaId != null && (media == null || media.Id == MediaId))
        {
            NavigationManager.NavigateTo(Urls.AdminMediaBaseUrl);
        }
        await Task.CompletedTask;
    }

    private static string GetCompositeKey(string? mediaId, string? parentId)
    {
        return $"{mediaId?.ToString() ?? "null"}_{parentId?.ToString() ?? "null"}";
    }

    public void Dispose()
    {
        AppState.OnMediaDeleted -= HandleMediaDeleted;
    }
}