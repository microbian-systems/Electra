@using ZauberCMS.Core.Content.Parameters
@using ZauberCMS.Components.Admin.ContentSection
@using Humanizer

<!-- Header -->
<div class="rz-mb-4 rz-p-3 border-b border-gray-200">
    <div class="flex justify-between items-start">
        <div>
            <RadzenText TextStyle="TextStyle.H5" class="font-medium text-gray-900">
                @Content?.Name
            </RadzenText>
            <RadzenText TextStyle="TextStyle.Body2" class="text-gray-500 mt-1">
                Last updated @Content?.DateUpdated.Humanize()
            </RadzenText>
        </div>
        <RadzenButton Variant="Variant.Filled" Icon="edit" Text="@($"Edit {Content?.Name}")" Click="OpenContentEditor" />
    </div>
</div>

<!-- Child Content Data Grid -->
<RadzenDataGrid AllowFiltering="true"
                FilterPopupRenderMode="PopupRenderMode.Initial"
                FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                AllowPaging="true"
                PageSize="@AmountPerPage"
                AllowSorting="true"
                LoadData="@LoadAllUserData"
                IsLoading="@IsLoading"
                Count="@AllUserCount"
                Data="@AllUserContents"
                SelectionMode="DataGridSelectionMode.Single"
                RowSelect="@((Content value) => OnRowSelect(value))"
                PagerHorizontalAlign="HorizontalAlign.Center">
    @*@bind-Value="@SelectedContent"*@
    <Columns>
        <RadzenDataGridColumn Property="Name" Title="Name"/>
        <RadzenDataGridColumn Property="DateUpdated" Title="Last Updated">
            <Template Context="data">
                @data.DateUpdated.Humanize()
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn Property="LastUpdatedBy" Title="Updated By">
            <Template Context="data">
                <RadzenGravatar Email="@data.LastUpdatedBy?.Email" Style="width: 25px; height: 25px;"/>
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn Property="Id" Title="Delete">
            <Template Context="data">
                <RadzenButton Variant="Variant.Text" Size="ButtonSize.Small" Text="Delete" Click="@(() => Delete(data.Id))"/>
            </Template>
        </RadzenDataGridColumn>
    </Columns>
</RadzenDataGrid>

@code {

    [Inject] public NotificationService NotificationService { get; set; } = null!;
    [Inject] public IModalService ModalService { get; set; } = null!;

    [Parameter] public Guid? ContentId { get; set; }
    [Parameter] public Guid? ParentId { get; set; }
    [Parameter] public Content? Content { get; set; }

    [Parameter] public int AmountPerPage { get; set; } = 20;
    [Parameter] public bool RefreshPage { get; set; }

    private bool IsLoading { get; set; } = false;
    private int AllUserCount { get; set; }
    private IEnumerable<Content> AllUserContents { get; set; } = [];
    
    private static string GetCompositeKey(Guid? contentId, Guid? parentId)
    {
        return $"{contentId?.ToString() ?? "null"}_{parentId?.ToString() ?? "null"}";
    }
    
    private async Task Delete(Guid id)
    {
        var result = await ContentService.DeleteContentAsync(new DeleteContentParameters { ContentId = id, MoveToRecycleBin = true});
        if (result.Success)
        {
            await LoadAllUserData(new LoadDataArgs { Top = AmountPerPage });
            NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Success, Summary = "Deleted", Duration = 4000 });
        }
        else
        {
            NotificationService.ShowNotifications(result.Messages);
        }
    }
    
    protected override async Task OnInitializedAsync()
    {
        await LoadAllUserData(new LoadDataArgs { Top = AmountPerPage });
    }
    
    async Task LoadAllUserData(LoadDataArgs args)
    {
        IsLoading = true;

        await Task.Yield();

        var command = new DataGridContentParameters();

        if (ContentId != null)
        {
            command.ParentId = ContentId;
        }

        if (args.Top != null && args.Top != 0)
        {
            command.Take = args.Top.Value;
        }

        if (args.Skip != null)
        {
            command.Skip = args.Skip.Value;
        }

        if (!string.IsNullOrEmpty(args.Filter))
        {
            // Filter via the Where method
            command.Filter = args.Filter;
        }

        if (!string.IsNullOrEmpty(args.OrderBy))
        {
            // Sort via the OrderBy method
            command.Order = args.OrderBy;
        }

        var result = await ContentService.GetDataGridContentAsync(command);
        AllUserCount = result.Count;
        AllUserContents = result.Items;

        IsLoading = false;
    }
    
    private async Task OpenContentEditor()
    {
        if (ContentId.HasValue)
        {
            var parameters = new Dictionary<string, object>
            {
                { "ContentId", ContentId.Value }
            };

            if (ParentId.HasValue)
            {
                parameters.Add("ParentId", ParentId.Value);
            }

            var dialog = ModalService.OpenSidePanel<ContentEditor>($"Edit {Content?.Name}", parameters);
            var result = await dialog.Result;
            if (result.Confirmed)
            {
                // Refresh the data grid if content was updated
                await LoadAllUserData(new LoadDataArgs { Top = AmountPerPage });
            }
        }
    }

    private void OnRowSelect(object value)
    {
        if (value is Content selectedRow)
        {
            NavigationManager.NavigateTo($"{Urls.AdminUpdateContent}/{selectedRow.Id}", RefreshPage);
        }
    }
}