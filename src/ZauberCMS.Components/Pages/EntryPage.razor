@using System.Collections.Concurrent
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Http
@using Microsoft.Extensions.Logging
@using Microsoft.Extensions.Options
@using ZauberCMS.Core
@using ZauberCMS.Core.Content.Parameters
@using ZauberCMS.Core.Middleware
@using ZauberCMS.Core.Plugins
@using ZauberCMS.Core.Settings
@using ZauberCMS.Core.Shared.Services

@if (ComponentView != null)
{
    <LayoutView Layout="LayoutType">
        <DynamicComponent Type="@ComponentView.GetType()" Parameters="@Parameters" />
    </LayoutView>
}

@code {
    [Inject] public ExtensionManager ExtensionManager { get; set; } = null!;
    [Inject] public LayoutResolverService LayoutResolver { get; set; } = null!;
    [Inject] public IOptions<ZauberSettings> Settings { get; set; } = null!;
    [Inject] public PersistentComponentState ApplicationState { get; set; } = null!;
    [Inject] public ILogger<EntryPage> Logger { get; set; } = null!;
    [Inject] public AuthenticationStateProvider AuthenticationStateProvider { get; set; } = null!;

    [CascadingParameter] private HttpContext? HttpContext { get; set; }
    
    [Parameter] public string? Slug { get; set; }

    private Content? Content { get; set; }
    private Dictionary<string, string> LanguageKeys { get; set; } = [];
    private string? LanguageIso { get; set; }
    private ConcurrentDictionary<string, IContentView> AllContentViews { get; set; } = new();
    private IContentView? ComponentView { get; set; }
    private Dictionary<string, object> Parameters { get; set; } = new();
    private Type LayoutType { get; set; } = null!;
    private AuthenticationState AuthState { get; set; } = null!;
    
    protected override async Task OnParametersSetAsync()
    {
        AuthState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var instances = ExtensionManager.GetInstances<IContentView>(true);
        AllContentViews = new ConcurrentDictionary<string, IContentView>(instances);
        
        // Try to get EntryModel from middleware first (avoids duplicate query)
        var entryModel = CultureMiddleware.GetEntryModel(HttpContext);
        if (entryModel == null)
        {
            // Fallback: query if middleware didn't process this route (e.g., admin pages)
            entryModel = await ContentService.GetContentFromRequestAsync(new GetContentFromRequestParameters { Slug = Slug, IsRootContent = Slug == null, Url = NavigationManager.Uri });
        }
        
        Content = entryModel.Content;
        LanguageKeys = entryModel.LanguageKeys;
        LanguageIso = entryModel.LanguageIsoCode ?? Settings.Value.AdminDefaultLanguage;
        
        if (Content != null)
        {
            if (AllContentViews.TryGetValue(Content.ViewComponent, out var contentView))
            {
                ComponentView = contentView;
                LayoutType = LayoutResolver.GetLayoutType(ComponentView.GetType());
                Parameters = new Dictionary<string, object> { ["Content"] = Content, ["LanguageKeys"] = LanguageKeys };
                
                // Note: Culture is now set by CultureMiddleware before this component renders
                
                // Role-based content restriction
                if (Content.ContentRoles.Count != 0)
                {
                    // Check if the user is authenticated and in a specific role
                    if (AuthState.User.Identity?.IsAuthenticated == true)
                    {
                        // Always allow admins regardless
                        if (!AuthState.User.IsInRole(Constants.Roles.AdminRoleName))
                        {
                            var userIsInRole = false;
                            
                            foreach (var contentRole in Content.ContentRoles)
                            {
                                if (contentRole.Role.Name != null && AuthState.User.IsInRole(contentRole.Role.Name))
                                {
                                    userIsInRole = true;
                                    break;
                                }
                            }   
                            
                            if (!userIsInRole)
                            {
                                // Redirect if the user is not in the role
                                NavigationManager.NavigateTo(Settings.Value.Identity.DefaultLoginRedirectUrl);
                            }
                        }
                    }
                    else
                    {
                        // Handle unauthenticated users (redirect to login)
                        NavigationManager.NavigateTo(Settings.Value.Identity.DefaultLoginRedirectUrl);
                    }
                }
            }
            else if (AllContentViews.TryGetValue(Settings.Value.MissingView!, out var missing))
            {
                ComponentView = missing;
                LayoutType = LayoutResolver.GetLayoutType(ComponentView.GetType());
                Parameters = new Dictionary<string, object> { ["Content"] = Content, ["LanguageKeys"] = LanguageKeys };
            }
        }
        else
        {
            var hasContent = await ContentService.AnyContentAsync();
            if (hasContent)
            {
                if (AllContentViews.TryGetValue(Settings.Value.NotFoundComponent!, out var notFound))
                {
                    ComponentView = notFound;
                    LayoutType = LayoutResolver.GetLayoutType(ComponentView.GetType());
                }
            }
            else if (AllContentViews.TryGetValue(Settings.Value.StarterComponent!, out var starter))
            {
                ComponentView = starter;
                LayoutType = LayoutResolver.GetLayoutType(ComponentView.GetType());
            }
        }
    }
}
