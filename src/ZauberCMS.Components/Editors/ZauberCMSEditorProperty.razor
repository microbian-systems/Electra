@using ZauberCMS.Components.Editors.Models
@using ZauberCMS.Components.Editors.Settings
@using ZauberCMS.RTE.Components
@using ZauberCMS.RTE.Models
@using HtmlAgilityPack
@using ZauberCMS.Core.Media.Interfaces
@using ZauberCMS.Core.Media.Parameters
@using ZauberCMS.Core.Content.Interfaces
@using ZauberCMS.Core.Content.Parameters
@using ZauberCMS.Core.Extensions
@using Radzen
@implements ZauberCMS.Core.Content.Interfaces.IContentProperty

<ZauberRichTextEditor @bind-Value="@Value"
                      Settings="@EditorSettings"
                      OnChange="@OnChange" />

@code {
    [Parameter] public string? Value { get; set; } = string.Empty;
    [Parameter] public string? Settings { get; set; }
    [Parameter] public EventCallback<string> ValueChanged { get; set; }
    [Parameter] public Content? Content { get; set; }
    
    [CascadingParameter] public IModalService? ModalService { get; set; }
    
    [Inject] public NotificationService NotificationService { get; set; } = null!;
    
    public string Name { get; set; } = "Text Editor (ZauberCMS RTE)";
    public string Alias { get; set; } = "ZauberCMS.ZauberRTE";
    public string Icon { get; set; } = "edit_note";
    public string Description { get; set; } = "ZauberCMS Rich Text Editor - Modern Blazor native editor";
    public Type? SettingsComponent { get; set; } = typeof(ZauberCMSEditorSettings);
    public List<string> Scripts { get; set; } = [];
    public List<string> Styles { get; set; } = [];
    public bool FullWidth { get; set; }
    
    private ZauberCMSEditorSettingsModel SettingsModel { get; set; } = new();
    private EditorSettings EditorSettings { get; set; } = new();
    private bool _initialized;

    protected override async Task OnParametersSetAsync()
    {
        if (!_initialized)
        {
            SettingsModel = Settings.FromJson<ZauberCMSEditorSettingsModel>();
            EditorSettings = BuildEditorSettings();
            _initialized = true;
            await ValidateEmbeddedReferences();
        }
    }

    private EditorSettings BuildEditorSettings()
    {
        // Use Minimal or customized CMS Default layout
        EditorSettings settings;
        
        if (SettingsModel.ToolbarLayout == "Minimal")
        {
            settings = EditorSettings.Minimal();
        }
        else
        {
            // Use CMS Default but customize to add insertMedia button
            settings = new EditorSettings
            {
                ToolbarLayout = ToolbarLayout.FromItems(
                    new ToolbarBlock("bold", "italic", "underline", "strike", "code", "subscript", "superscript"),
                    new ToolbarSeparator(),
                    new ToolbarBlock("headings", "blockquote"),
                    new ToolbarSeparator(),
                    new ToolbarBlock("ul", "ol", "insertContentLink", "unlink", "image", "insertMedia"),
                    new ToolbarSeparator(),
                    new ToolbarBlock("alignLeft", "alignCenter", "alignRight", "justified"),
                    new ToolbarSeparator(),
                    new ToolbarBlock("clean-html", "undo", "redo", "viewSource", "themeToggle")
                )
            };
        }

        // Apply height if specified
        if (!string.IsNullOrWhiteSpace(SettingsModel.Height))
        {
            settings.Dimensions = new EditorDimensions
            {
                Height = SettingsModel.Height
            };
        }

        // Apply image constraints
        settings.ImageConstraints = new ImageConstraints
        {
            AllowBase64ImageUpload = SettingsModel.AllowBase64ImageUpload
        };

        return settings;
    }

    private async Task OnChange(EditorChangeArgs args)
    {
        await ValueChanged.InvokeAsync(args.Html);
    }

    private async Task ValidateEmbeddedReferences()
    {
        if (string.IsNullOrWhiteSpace(Value)) return;
        
        var doc = new HtmlDocument();
        doc.LoadHtml(Value);
        
        var updatedUrls = new List<string>();
        var deletedItems = new List<string>();
        var htmlChanged = false;
        
        // Validate media references (images and media links)
        var mediaNodes = doc.DocumentNode.SelectNodes("//*[@data-mediaid]");
        if (mediaNodes != null && mediaNodes.Any())
        {
            foreach (var node in mediaNodes)
            {
                var mediaIdStr = node.GetAttributeValue("data-mediaid", string.Empty);
                if (!Guid.TryParse(mediaIdStr, out var mediaId)) continue;
                
                // Query media service
                var media = await MediaService.GetMediaAsync(new GetMediaParameters 
                { 
                    Id = mediaId, 
                    AsNoTracking = true 
                });
                
                if (media == null)
                {
                    // Media deleted - remove the element
                    node.Remove();
                    deletedItems.Add(mediaIdStr);
                    htmlChanged = true;
                }
                else
                {
                    // Determine which attribute to check based on node type
                    var urlAttribute = node.Name == "img" ? "src" : "href";
                    var currentUrl = node.GetAttributeValue(urlAttribute, string.Empty);
                    
                    // Check if URL changed and update if needed
                    if (!string.IsNullOrEmpty(media.Url) && currentUrl != media.Url)
                    {
                        node.SetAttributeValue(urlAttribute, media.Url);
                        updatedUrls.Add(media.Name ?? "Unnamed");
                        htmlChanged = true;
                    }
                }
            }
        }
        
        // Validate content link references
        var contentLinkNodes = doc.DocumentNode.SelectNodes("//a[@data-contentid]");
        if (contentLinkNodes != null && contentLinkNodes.Any())
        {
            foreach (var node in contentLinkNodes)
            {
                var contentIdStr = node.GetAttributeValue("data-contentid", string.Empty);
                if (!Guid.TryParse(contentIdStr, out var contentId)) continue;
                
                // Query content service
                var content = await ContentService.GetContentAsync(new GetContentParameters
                {
                    Id = contentId,
                    AsNoTracking = true
                });
                
                if (content == null)
                {
                    // Content deleted - remove link but preserve inner text
                    var innerText = node.InnerText;
                    var textNode = doc.CreateTextNode(innerText);
                    node.ParentNode.ReplaceChild(textNode, node);
                    deletedItems.Add(contentIdStr);
                    htmlChanged = true;
                }
                else
                {
                    // Check if URL changed and update if needed
                    var currentHref = node.GetAttributeValue("href", string.Empty);
                    var contentUrl = content.Url();
                    
                    if (!string.IsNullOrEmpty(contentUrl) && currentHref != contentUrl)
                    {
                        node.SetAttributeValue("href", contentUrl);
                        updatedUrls.Add(content.Name ?? "Unnamed");
                        htmlChanged = true;
                    }
                }
            }
        }
        
        // Update editor value if changes were made
        if (htmlChanged)
        {
            Value = doc.DocumentNode.OuterHtml;
            await ValueChanged.InvokeAsync(Value);
            
            // Show notifications
            if (updatedUrls.Any())
            {
                var detail = $"{updatedUrls.Count} link URL(s) updated. Please save the page to persist changes.";
                NotificationService.ShowNotification("URLs Updated", NotificationSeverity.Info, detail);
            }
            
            if (deletedItems.Any())
            {
                var detail = $"{deletedItems.Count} deleted item(s) removed or unlinked. Please save the page to persist changes.";
                NotificationService.ShowWarningNotification("Deleted Items Removed", detail);
            }
        }
    }
}