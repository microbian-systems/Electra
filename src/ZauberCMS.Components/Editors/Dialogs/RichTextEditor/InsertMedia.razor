@using System.Text
@using Radzen.Blazor.Rendering
@using ZauberCMS.Core.Media.Models
@inherits RadzenHtmlEditorButtonBase
@inject IModalService DialogService

<EditorButton Click="@OnClick" Icon="insert_photo" Title="@Title" />

@code {
    /// <summary>
    /// Specifies the title (tooltip) displayed when the user hovers the tool. Set to <c>"Insert image"</c> by default.
    /// </summary>
    [Parameter]
    public string Title { get; set; } = "Insert image";

    /// <summary>
    /// Specifies the text of button which inserts the image. Set to <c>"OK"</c> by default.
    /// </summary>
    [Parameter]
    public string OkText { get; set; } = "OK";

    /// <summary>
    /// Specifies the text of button which cancels image insertion and closes the dialog. Set to <c>"Cancel"</c> by default.
    /// </summary>
    [Parameter]
    public string CancelText { get; set; } = "Cancel";

    private Media? SelectedMedia { get; set; }
    private Guid? SelectedMediaId { get; set; }
    private IModalReference? Modal { get; set; }

    protected override async Task OnClick()
    {
        await Editor.SaveSelectionAsync();

        var parameters = new Dictionary<string, object>
        {
            { nameof(MediaTree.ValueChanged), EventCallback.Factory.Create<object>(this, OnMediaIdSelected) },
            { nameof(MediaTree.DisableContextMenu), true },
            { nameof(MediaTree.MediaTypes), new List<MediaType> { MediaType.Image } }
        };

        Modal = DialogService.OpenSidePanel<MediaTree>(Title, parameters);
        var result = await Modal.Result;
        
        if (result.Confirmed && SelectedMedia != null)
        {
            await Editor.RestoreSelectionAsync();
            await InsertImage(SelectedMedia);
        }
    }

    private void OnMediaIdSelected(object value)
    {
        if (value is Media { MediaType: MediaType.Image } media)
        {
            SelectedMediaId = media.Id;
            SelectedMedia = media;
            Modal?.Close(ModalResult.Ok(media));
        }
    }

    private async Task InsertImage(Media media)
    {
        var html = new StringBuilder();
        html.AppendFormat("<img src=\"{0}\"", media.Url);
        html.AppendFormat(" width=\"{0}\"", media.Width);
        html.AppendFormat(" height=\"{0}\"", media.Height);
        html.AppendFormat(" data-media-id=\"{0}\"", media.Id);
        html.Append(">");

        await Editor.ExecuteCommandAsync("insertHTML", html.ToString());
    }
}