@using ZauberCMS.Core
@using ZauberCMS.Core.Content.Parameters
@using ZauberCMS.Core.Shared
@implements IDisposable

<BaseTree
    T="ContentType"
    Data="@Data"
    TreeAlias="@Alias"
    Expand="@OnExpandHandler"
    Change="@OnChangeHandler"
    @bind-Value="@Value"
    HasChildren="@(e => HasChildren(e))"
    DisableContextMenu="DisableContextMenu"
    DisableSectionOnlyContextMenu="DisableSectionOnlyContextMenu"
    ShouldBeExpanded="@(e => ShouldBeExpanded(e))"
    Template="@(TreeExtensions.CreateContentTypeTreeTemplate<object>())">
</BaseTree>

@code {
    [Inject] public AppState AppState { get; set; } = null!;
    [Inject] public TreeState TreeState { get; set; } = null!;
    
    [Parameter] public IEnumerable<ContentType> Data { get; set; } = [];
    [Parameter] public EventCallback<TreeExpandEventArgs> OnExpand { get; set; }
    [Parameter] public Func<object, bool>? Children { get; set; }
    [Parameter] public object? Value { get; set; }
    [Parameter] public EventCallback Change { get; set; }
    [Parameter] public EventCallback<object> ValueChanged { get; set; }
    [Parameter] public bool DisableContextMenu { get; set; }
    [Parameter] public bool DisableSectionOnlyContextMenu { get; set; }
    [Parameter] public string Alias { get; set; } = Constants.Sections.Trees.ContentTypeTree;
    
    // Dictionary to cache HasChildren results
    
    protected override void OnInitialized()
    {
        AppState.OnContentTypeChanged += HandleContentTypeChanged;
    }
    
    protected override async Task OnParametersSetAsync()
    {
        if (!Data.Any())
        {
            var items = await ContentService.QueryContentTypesAsync(new QueryContentTypesParameters
            {
                AmountPerPage = 100,
                IncludeFolders = true,
                WhereClause = x => x.ParentId == null,
                OrderBy = GetContentTypesOrderBy.Name
            });
            
            Data = items.Items.ToList();
        }
    }
    
    private Task HandleContentTypeChanged(ContentType? contentType, string username)
    {
        TreeState.ClearChildCache(null);
        return Task.CompletedTask;
    }

    private async Task OnExpandHandler(TreeExpandEventArgs args)
    {
        if (OnExpand.HasDelegate)
        {
            await OnExpand.InvokeAsync(args);
        }
        else
        {
            if (args.Value is ContentType content)
            {
                var items = ContentService.QueryContentTypesAsync(new QueryContentTypesParameters
                {
                    WhereClause = x => x.ParentId == content.Id,
                    AmountPerPage = 100,
                    IncludeFolders = true,
                    OrderBy = GetContentTypesOrderBy.Name
                }).GetAwaiter().GetResult();
                args.Children.Data = items.Items;
                args.Children.TextProperty = "Name";
                args.Children.Template = TreeExtensions.CreateContentTypeTreeTemplate<RadzenTreeItem>();
                args.Children.HasChildren = HasChildren;
                
                TreeState.NodeExpanded(content.Id);
            }
        }
    }

    private async Task OnChangeHandler()
    {
        await ValueChanged.InvokeAsync(Value);
        if (Change.HasDelegate)
        {
            await Change.InvokeAsync();
        }
    }

    private bool HasChildren(object data)
    {
        if (Children != null)
        {
            // Use the user-provided method
            return Children(data);
        }
        else
        {
            if (data is ContentType content)
            {
                // Check if result is cached
                if (TreeState.HasChildrenCache.TryGetValue(content.Id, out var hasChildren))
                {
                    return hasChildren;
                }

                // Calculate result and cache it
                hasChildren = Task.Run(() => ContentService.HasChildContentTypeAsync(new HasChildContentTypeParameters { ParentId = content.Id })).GetAwaiter().GetResult();
                TreeState.SetChildren(content.Id, hasChildren);

                return hasChildren;
            }

            return false;   
        }
    }

    private bool ShouldBeExpanded(object data)
    {
        if (data is ContentType content)
        {
            return (HasChildren(content) && content.ParentId == null) || TreeState.IsNodeExpanded(content.Id);
        }

        return false;
    }

    public void Dispose()
    {
        AppState.OnContentTypeChanged -= HandleContentTypeChanged;
    }
}